name: Implementation process pipeline
run-name: ${{ github.actor }} is running the pipeline
on: [push]

env:
  ap_url: https://data.vlaanderen.be/doc/applicatieprofiel/leermiddelen/ontwerpstandaard/2025-03-21/
  shacl_url: https://data.vlaanderen.be/doc/applicatieprofiel/leermiddelen/ontwerpstandaard/2025-03-21/shacl/leermiddelen-ap-SHACL.ttl

jobs:
  Set-Up-Repo:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v5
      - run: echo "üñ•Ô∏è The workflow is now ready to test your code on the runner."
      - name: Download SHACL if needed
        run: ./scripts/download-shacl.sh $shacl_url
      - uses: EndBug/add-and-commit@v9
        with:
          add: shacl.ttl
          message: "Add SHACL"
      - name: Add AP and SHACL links to README
        run: ./scripts/update-readme.sh $ap_url $shacl_url
      - uses: EndBug/add-and-commit@v9
        with:
          add: README.md original-README.md
          message: "Add AP and SHACL links to README"
      - name: "[Placeholder] Generate template Excel"
        run: echo "Generating Excel template."
      - name: Create output directory
        run: mkdir -p output

  Generate-RDF-Build-Miravi:
    runs-on: ubuntu-latest
    needs: Set-Up-Repo
    steps:
      - name: Check out repository code
        uses: actions/checkout@v5
      - name: Clone ap-data-to-dashboard
        uses: actions/checkout@v5
        with:
          repository: RMLio/ap-data-to-dashboard
          path: ap-data-to-dashboard
      - uses: actions/setup-node@v6
        with:
          node-version: 22
      - name: "Copy input data to in directory"
        run: | 
          rm -rf ap-data-to-dashboard 
          cp data/* ap-data-to-dashboard/in/*
      - name: "Install ap-data-in-dashboard"
        run: |
          cd ap-data-to-dashboard
          npm i
          npm run setup
          rm -rf subprojects && mkdir subprojects && pushd subprojects
          git clone -b v2.1.1 https://github.com/SolidLabResearch/miravi-a-linked-data-viewer.git
          (cd miravi-a-linked-data-viewer/main && npm i)
          popd
      - name: "Generate RDF and build Miravi"
        run: |
          cd ap-data-to-dashboard
          ./run.sh -u http://localhost:5500/output.ttl
      - name: Clean docs directory
        run: rm -rf docs && mkdir docs
      - name: Move Miravi dist directory to docs
        run: mv subprojects/miravi-a-linked-data-viewer/main/dist/* docs
      - uses: EndBug/add-and-commit@v9
        with:
          add: output/data.ttl
          message: "Add generated RDF and Miravi build"
